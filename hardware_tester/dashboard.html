<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hardware Tester Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #181a20;
            color: #e0e0e0;
            width: 100vw;
            height: 100vh;
            overflow-x: hidden;
        }
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            justify-content: center;
            align-items: flex-start;
        }
        .card {
            background: #23272f;
            border-radius: 8px;
            box-shadow: 0 2px 8px #111;
            padding: 0.5em 0.5em;
            margin-bottom: 1em;
            min-width: 180px;
            max-width: 320px;
            flex: 1 1 180px;
        }
        .card h2 {
            margin-top: 0;
            color: #90caf9;
            font-size: 1.1em;
            text-align: center;
        }
        .summary {
            display: flex;
            gap: 1em;
            margin-bottom: 0.5em;
            justify-content: center;
        }
        .summary-item {
            background: #263238;
            border-radius: 6px;
            padding: 0.5em 1em;
            font-size: 1em;
            color: #90caf9;
            box-shadow: 0 1px 4px #111;
            min-width: 120px;
            text-align: center;
        }
        .error { color: #ff5252; font-weight: bold; }
        .warn { color: #ffb300; font-weight: bold; }
        #voltageChart { background: #23272f; border-radius: 8px; max-width: 100%; height: 120px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5em;
            font-size: 0.95em;
        }
        th, td {
            padding: 0.3em 0.5em;
            border-bottom: 1px solid #333;
            text-align: left;
        }
        th {
            background: #263238;
            color: #90caf9;
            font-size: 1em;
        }
        tr:last-child td { border-bottom: none; }
        button {
            background: #263238;
            color: #90caf9;
            border: none;
            border-radius: 4px;
            padding: 0.7em 2em;
            cursor: pointer;
            font-size: 1.1em;
            margin: 0.5em auto 1em auto;
            display: block;
        }
        @media (max-width: 900px) {
            .dashboard-container {
                flex-direction: column;
                align-items: stretch;
            }
            .card {
                max-width: 100vw;
                min-width: 0;
            }
        }
        @media (max-width: 600px) {
            html, body {
                font-size: 1.1em;
            }
            .card {
                padding: 0.3em 0.2em;
            }
            th, td {
                padding: 0.2em 0.3em;
            }
            button {
                padding: 0.5em 1em;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <h1 style="color:#90caf9; margin:0.5em 0 0.2em 0; text-align:center; font-size:1.3em;">Hardware Tester Dashboard</h1>
    <div class="summary">
        <div class="summary-item" id="summary-status">Status: ...</div>
        <div class="summary-item" id="summary-voltage">Voltage OK: ...</div>
    </div>
    <button onclick="fetchAll()" style="margin-left:1em; background:#263238; color:#90caf9; border:none; border-radius:4px; padding:0.5em 1.5em; cursor:pointer;">Refresh All</button>
    <div class="dashboard-container">
        <div class="card" style="flex:1; min-width:300px;">
            <h2>Voltage Divider</h2>
            <canvas id="voltageChart" width="600" height="200"></canvas>
            <div id="voltage-table">Loading...</div>
        </div>
        <div class="card" style="flex:1; min-width:300px;">
            <h2>Arduino Nano Inputs</h2>
            <div id="arduino-table">Loading...</div>
        </div>
        <div class="card" style="flex:1; min-width:300px;">
            <h2>GPS</h2>
            <div id="gps-table">Loading...</div>
        </div>
        <div class="card" style="flex:1; min-width:300px;">
            <h2>RTC</h2>
            <div id="rtc-table">Loading...</div>
        </div>
    </div>
    <div class="dashboard-container" style="margin-top:0;">
        <div class="card" style="width:100%; max-width:900px; min-width:200px;">
            <h2>Logs <span style="font-size:0.8em;">(auto-refresh)</span></h2>
            <div style="display:flex; gap:0.5em; align-items:center; margin-bottom:0.5em; flex-wrap:wrap;">
                <input id="log-search" type="text" placeholder="Search logs..." style="flex:2; min-width:120px; padding:0.3em; border-radius:4px; border:none; background:#263238; color:#90caf9; font-size:1em;">
                <select id="log-filter" style="flex:1; min-width:80px; padding:0.3em; border-radius:4px; border:none; background:#263238; color:#90caf9; font-size:1em;">
                    <option value="ALL">All</option>
                    <option value="ERROR">Error</option>
                    <option value="WARN">Warning</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>
            <pre id="logs" style="height:180px; max-height:30vh; overflow-y:auto; font-size:1em; background:#181a20; border-radius:6px; padding:0.7em; white-space:pre-wrap; word-break:break-word;">Loading...</pre>
        </div>
    </div>
    <script>
    async function fetchStatus() {
        // Clear all tables
        document.getElementById('voltage-table').textContent = 'Loading...';
        document.getElementById('arduino-table').textContent = 'Loading...';
        document.getElementById('gps-table').textContent = 'Loading...';
        document.getElementById('rtc-table').textContent = 'Loading...';
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            if (data.error) {
                document.getElementById('voltage-table').innerHTML = `<span class='error'>Error: ${data.error}</span>`;
                document.getElementById('arduino-table').innerHTML = `<span class='error'>Error: ${data.error}</span>`;
                document.getElementById('gps-table').innerHTML = `<span class='error'>Error: ${data.error}</span>`;
                document.getElementById('rtc-table').innerHTML = `<span class='error'>Error: ${data.error}</span>`;
                document.getElementById('summary-status').textContent = 'Status: Error';
                return;
            }
            // Voltage Divider Table
            let vhtml = '<table><thead><tr><th>Divider</th><th>Status</th></tr></thead><tbody>';
            Object.entries(data.voltage_divider).forEach(([name, status]) => {
                let cls = status === 'OK' || status === true ? '' : (status === 'WARN' ? 'warn' : 'error');
                vhtml += `<tr><td>${name}</td><td class="${cls}">${status}</td></tr>`;
            });
            vhtml += '</tbody></table>';
            document.getElementById('voltage-table').innerHTML = vhtml;

            // Arduino Table
            let ahtml = '<table><thead><tr><th>Sensor</th><th>Value</th></tr></thead><tbody>';
            Object.entries(data.arduino).forEach(([sensor, value]) => {
                ahtml += `<tr><td>${sensor}</td><td>${value}</td></tr>`;
            });
            ahtml += '</tbody></table>';
            document.getElementById('arduino-table').innerHTML = ahtml;

            // GPS Table
            let ghtml = '<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
            Object.entries(data.gps).forEach(([field, value]) => {
                let cls = value === 'WARN' ? 'warn' : value === 'FAIL' ? 'error' : '';
                ghtml += `<tr><td>${field}</td><td class="${cls}">${value}</td></tr>`;
            });
            ghtml += '</tbody></table>';
            document.getElementById('gps-table').innerHTML = ghtml;

            // RTC Table
            let rhtml = '<table><thead><tr><th>Date/Time</th></tr></thead><tbody>';
            rhtml += `<tr><td>${data.rtc.datetime}</td></tr>`;
            rhtml += '</tbody></table>';
            document.getElementById('rtc-table').innerHTML = rhtml;

            document.getElementById('summary-status').textContent = 'Status: OK';
            let okCount = Object.values(data.voltage_divider).filter(v => v === 'OK' || v === true).length;
            document.getElementById('summary-voltage').textContent = `Voltage OK: ${okCount}`;
        } catch (err) {
            document.getElementById('voltage-table').innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
            document.getElementById('arduino-table').innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
            document.getElementById('gps-table').innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
            document.getElementById('rtc-table').innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
            document.getElementById('summary-status').textContent = 'Status: Error';
        }
    }

    async function fetchVoltage() {
        const voltageTable = document.getElementById('voltage-table');
        voltageTable.textContent = 'Loading...';
        try {
            const response = await fetch('/api/voltage');
            const data = await response.json();
            if (data.error) {
                voltageTable.innerHTML = `<span class='error'>Error: ${data.error}</span>`;
                document.getElementById('summary-voltage').textContent = 'Voltage OK: Error';
            } else {
                renderVoltageChart(data);
                // Table for voltage divider
                let html = '<table><thead><tr><th>Divider</th><th>Status</th></tr></thead><tbody>';
                Object.entries(data).forEach(([name, status]) => {
                    let cls = status === 'OK' || status === true ? '' : (status === 'WARN' ? 'warn' : 'error');
                    html += `<tr><td>${name}</td><td class="${cls}">${status}</td></tr>`;
                });
                html += '</tbody></table>';
                voltageTable.innerHTML = html;
                let okCount = Object.values(data).filter(v => v === 'OK' || v === true).length;
                document.getElementById('summary-voltage').textContent = `Voltage OK: ${okCount}`;
            }
        } catch (err) {
            voltageTable.innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
            document.getElementById('summary-voltage').textContent = 'Voltage OK: Error';
        }
    }

    let allLogLines = [];
    function renderLogs() {
        const search = document.getElementById('log-search').value.trim().toLowerCase();
        const filter = document.getElementById('log-filter').value;
        const logsElem = document.getElementById('logs');
        let filtered = allLogLines.filter(line => {
            if (filter !== 'ALL') {
                if (filter === 'ERROR' && !/ERROR|CRITICAL/.test(line)) return false;
                if (filter === 'WARN' && !/WARN|WARNING/.test(line)) return false;
                if (filter === 'INFO' && !/INFO/.test(line)) return false;
                if (filter === 'DEBUG' && !/DEBUG/.test(line)) return false;
            }
            if (search && !line.toLowerCase().includes(search)) return false;
            return true;
        });
        // Colorize and highlight search
        const colorize = line => {
            let html = line;
            if (/ERROR|CRITICAL/.test(line)) html = `<span style='color:#ff5252;font-weight:bold;'>${html}</span>`;
            else if (/WARN|WARNING/.test(line)) html = `<span style='color:#ffb300;'>${html}</span>`;
            else if (/INFO/.test(line)) html = `<span style='color:#90caf9;'>${html}</span>`;
            else if (/DEBUG/.test(line)) html = `<span style='color:#b2ff59;'>${html}</span>`;
            if (search) {
                const re = new RegExp(`(${search.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                html = html.replace(re, '<mark style="background:#ffb300;color:#23272f;">$1</mark>');
            }
            return html;
        };
        logsElem.innerHTML = filtered.map(colorize).join('');
    }

    async function fetchLogs() {
        try {
            const response = await fetch('/api/logs');
            const data = await response.json();
            if (data.error) {
                document.getElementById('logs').innerHTML = `<span class='error'>Error: ${data.error}</span>`;
            } else {
                allLogLines = data.logs;
                renderLogs();
            }
        } catch (err) {
            document.getElementById('logs').innerHTML = `<span class='error'>Fetch failed: ${err}</span>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('log-search').addEventListener('input', renderLogs);
        document.getElementById('log-filter').addEventListener('change', renderLogs);
    });

    function fetchAll() {
        fetchStatus();
        fetchVoltage();
        fetchLogs();
    }
    // Auto-refresh logs every 5 seconds
    setInterval(fetchLogs, 5000);

    // Chart.js voltage divider visualization
    let voltageChart;
    function renderVoltageChart(data) {
        const ctx = document.getElementById('voltageChart').getContext('2d');
        const labels = Object.keys(data);
        const values = labels.map(k => {
            if (typeof data[k] === 'string') {
                if (data[k] === 'OK') return 1;
                if (data[k] === 'WARN') return 0.5;
                return 0;
            }
            return data[k] ? 1 : 0;
        });
        if (voltageChart) voltageChart.destroy();
        voltageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Voltage Divider Status',
                    data: values,
                    backgroundColor: values.map(v => v === 1 ? 'green' : v === 0.5 ? 'orange' : 'red'),
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 1 }
                }
            }
        });
    }

    fetchAll();
    </script>
</body>
</html>
